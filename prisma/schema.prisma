// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  refreshTokens     RefreshToken[]
  instagramAccounts InstagramAccount[]
  automationRules   AutomationRule[]
  settings          UserSettings?

  @@index([email])
  @@map("users")
}

model UserSettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  timezone            String   @default("UTC")
  maxRepliesPerHour   Int      @default(30)
  replyDelayMinSecs   Int      @default(5)
  replyDelayMaxSecs   Int      @default(30)
  blockedKeywords     String[] @default([])
  ignoredUsernames    String[] @default([])
  notifyOnTokenExpiry Boolean  @default(true)
  notifyOnRuleFailure Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model InstagramAccount {
  id                          String   @id @default(cuid())
  userId                      String
  instagramUserId             String   @unique
  instagramBusinessAccountId  String?  @unique // For webhook matching
  username                    String
  profilePictureUrl           String?
  followersCount              Int?
  followingCount              Int?
  mediaCount                  Int?
  biography                   String?
  isBusinessAccount           Boolean  @default(false)
  isConnected                 Boolean  @default(true)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  user            User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokens          InstagramToken?
  events          WebhookEvent[]
  comments        InstagramComment[]
  automationRules AutomationRule[]
  snapshots       InstagramAccountSnapshot[]

  @@index([userId])
  @@index([instagramUserId])
  @@index([instagramBusinessAccountId])
  @@map("instagram_accounts")
}

model InstagramAccountSnapshot {
  id             String   @id @default(cuid())
  accountId      String
  followersCount Int
  followingCount Int
  mediaCount     Int
  createdAt      DateTime @default(now())

  account InstagramAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([accountId, createdAt])
  @@map("instagram_account_snapshots")
}

model InstagramToken {
  id                 String    @id @default(cuid())
  instagramAccountId String    @unique
  accessToken        String    @db.Text
  tokenType          String    @default("Bearer")
  expiresAt          DateTime?
  scope              String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  instagramAccount InstagramAccount @relation(fields: [instagramAccountId], references: [id], onDelete: Cascade)

  @@index([instagramAccountId])
  @@map("instagram_tokens")
}

model WebhookEvent {
  id              String    @id @default(cuid())
  eventType       String    // "comments", "mentions", "messages", "media"
  instagramUserId String    // Instagram user ID who triggered event
  accountId       String    // Our Instagram account that received event
  eventHash       String    @unique // Idempotency key (derived from payload)
  payload         Json      // Full webhook payload
  processed       Boolean   @default(false)
  processedAt     DateTime?
  error           String?
  createdAt       DateTime  @default(now())

  account InstagramAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([eventType])
  @@index([processed])
  @@index([createdAt])
  @@map("webhook_events")
}

model InstagramComment {
  id        String   @id @default(cuid())
  commentId String   @unique // Instagram comment ID
  accountId String
  mediaId   String   // Post ID
  text      String   @db.Text
  username  String   // Commenter username
  timestamp DateTime
  isReply   Boolean  @default(false)
  parentId  String?  // If reply, parent comment ID
  replied   Boolean  @default(false)
  replyText String?  @db.Text
  repliedAt DateTime?
  // DM tracking (v1.2.0)
  dmSent    Boolean   @default(false)
  dmText    String?   @db.Text
  dmSentAt  DateTime?
  dmError   String?   // Error message if DM failed
  createdAt DateTime @default(now())

  account InstagramAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([mediaId])
  @@index([commentId])
  @@map("instagram_comments")
}

model AutomationRule {
  id           String    @id @default(cuid())
  userId       String
  accountId    String
  name         String
  description  String?
  isActive     Boolean   @default(true)
  trigger      String    // "comment", "mention", "message"
  conditions   Json      // Flexible conditions
  actions      Json      // Flexible actions
  triggerCount  Int       @default(0)
  replyCount    Int       @default(0)
  likeCount     Int       @default(0)
  dmCount       Int       @default(0)
  lastTriggered DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  account InstagramAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
  @@index([trigger])
  @@index([isActive])
  @@map("automation_rules")
}
